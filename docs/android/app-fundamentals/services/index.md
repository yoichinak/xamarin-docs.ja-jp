---
title: Android サービスの作成
description: このガイドでは、アクティブなユーザーインターフェイスを使用せずに作業を行うことができる Android コンポーネントである Xamarin の Android サービスについて説明します。 サービスは、時間のかかる計算、ファイルのダウンロード、音楽の再生など、バックグラウンドで実行されるタスクによく使用されます。 サービスがに適しているさまざまなシナリオについて説明し、実行時間の長いバックグラウンドタスクを実行する場合と、リモートプロシージャコールのインターフェイスを提供する場合の両方について説明します。
ms.prod: xamarin
ms.assetid: BA371A59-6F7A-F62A-02FC-28253504ACC9
ms.technology: xamarin-android
author: davidortinau
ms.author: daortin
ms.date: 03/19/2018
ms.openlocfilehash: b427bbadc72ca557a37c652e853674fdf849c2c8
ms.sourcegitcommit: 2fbe4932a319af4ebc829f65eb1fb1816ba305d3
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/29/2019
ms.locfileid: "73024554"
---
# <a name="creating-android-services"></a>Android サービスの作成

_このガイドでは、アクティブなユーザーインターフェイスを使用せずに作業を行うことができる Android コンポーネントである Xamarin の Android サービスについて説明します。サービスは、時間のかかる計算、ファイルのダウンロード、音楽の再生など、バックグラウンドで実行されるタスクによく使用されます。サービスがに適しているさまざまなシナリオについて説明し、実行時間の長いバックグラウンドタスクを実行する場合と、リモートプロシージャコールのインターフェイスを提供する場合の両方について説明します。_

## <a name="android-services-overview"></a>Android サービスの概要

モバイルアプリはデスクトップアプリに似ていません。 デスクトップには、画面の不動産、メモリ、記憶領域、接続されている電源など、copious のリソースがありますが、モバイルデバイスにはありません。 これらの制約により、モバイルアプリの動作が異なります。 たとえば、モバイルデバイスの小さい画面は、通常、一度に1つのアプリ (つまり、アクティビティ) のみが表示されることを意味します。 その他のアクティビティはバックグラウンドに移動され、中断状態になり、作業を実行できなくなります。 ただし、Android アプリケーションがバックグラウンドで実行されることは、アプリが動作し続けることができないという意味ではありません。 

Android アプリケーションは、_アクティビティ_、_ブロードキャストレシーバー_、_コンテンツプロバイダー_、および_サービス_の4つの主要コンポーネントのうち、少なくとも1つで構成されています。 アクティビティは、ユーザーがアプリケーションと対話できるようにする UI を提供するので、多くの優れた Android アプリケーションの基礎となります。 ただし、同時実行またはバックグラウンドの作業を実行する場合は、アクティビティが常に最適な選択肢であるとは限りません。

Android でのバックグラウンド作業の主要なメカニズムは、_サービス_です。 Android サービスは、ユーザーインターフェイスなしで何らかの処理を行うように設計されたコンポーネントです。 サービスは、ファイルをダウンロードしたり、音楽を再生したり、画像にフィルターを適用したりすることがあります。 サービスは、Android アプリケーション間のプロセス間通信 (_IPC_) にも使用できます。 たとえば、ある Android アプリで別のアプリのミュージックプレーヤーサービスを使用している場合や、アプリがサービスを介して他のアプリにデータ (個人の連絡先情報など) を公開する場合があります。 

サービス、およびバックグラウンド処理を実行する機能は、スムーズで滑らかなユーザーインターフェイスを提供するうえで非常に重要です。 すべての Android アプリケーションには、アクティビティを実行する_メインスレッド_( _UI スレッド_とも呼ばれます) があります。 Android では、デバイスの応答性を維持するために、1秒あたり60フレームのレートでユーザーインターフェイスを更新できる必要があります。 Android アプリがメインスレッドで実行する作業が多すぎる場合、Android はフレームを削除します。これにより、UI が不自然 ( _janky_とも呼ばれます) として表示されます。 つまり、UI スレッドで実行されるすべての作業は、2つのフレームの間の時間内に完了する必要があります。約16ミリ秒 (60 フレームごとに1秒) です。 

この問題に対処するために、開発者はアクティビティ内のスレッドを使用して、UI をブロックする何らかの作業を実行する場合があります。 ただし、これによって問題が発生する可能性があります。 Android では、アクティビティの複数のインスタンスが破棄され、再作成される可能性が非常に高くなります。 ただし、Android ではスレッドが自動的に破棄されないため、メモリリークが発生する可能性があります。 この例として、[デバイスがローテーションさ](~/android/app-fundamentals/handling-rotation.md)れると &ndash; Android はアクティビティのインスタンスを破棄し、新しいアクティビティを再作成しようとします。

![デバイスの回転時にインスタンス1が破棄され、インスタンス2が作成されます。](images/image-01.png)

これは、アクティビティの最初のインスタンスによって作成されたスレッドがまだ実行されている &ndash;、メモリリークの可能性があります。 スレッドがアクティビティの最初のインスタンスへの参照を保持している場合、Android がオブジェクトをガベージコレクションするのを防ぐことができます。 ただし、アクティビティの2番目のインスタンスはまだ作成されています (これにより、新しいスレッドが作成される場合があります)。 デバイスを急速に連続して回転させると、すべての RAM が枯渇し、Android はアプリケーション全体を強制的に終了してメモリを再利用できるようになります。

経験則として、実行する作業でアクティビティを直後する必要がある場合は、その作業を実行するためにサービスを作成する必要があります。 ただし、作業がアクティビティのコンテキストでのみ適用される場合は、作業を実行するスレッドを作成する方が適切な場合があります。 たとえば、フォトギャラリーアプリに追加された写真のサムネイルを作成することは、サービスで発生する可能性があります。 ただし、スレッドは、アクティビティがフォアグラウンドにあるときにのみ聞こえなければならない音楽を再生する方が適している場合があります。

バックグラウンド作業は、次の2つの広範な分類に分けることができます。

1. **長時間実行**されるタスク &ndash; これは、明示的に停止するまで実行中の作業です。 _実行時間の長いタスク_の例として、音楽をストリーミングするアプリや、センサーから収集されたデータを監視するアプリがあります。 これらのタスクは、アプリケーションに表示されるユーザーインターフェイスがない場合でも実行する必要があります。
2. **定期的なタスク**&ndash; (_ジョブ_と呼ばれることもあります) は、定期的なタスクとは、比較的短い時間 (数秒) で、スケジュールに従って実行されるタスク (たとえば、1日に1回、または次の60秒で1回だけ) に実行されるタスクです。 たとえば、インターネットからファイルをダウンロードしたり、画像のサムネイルを生成したりすることができます。

Android サービスには、次の4種類があります。

* **バインドさ**れたサービス &ndash; バインド_され_たサービスは、他のコンポーネント (通常はアクティビティ) をバインドしているサービスです。 バインドされたサービスは、バインドされたコンポーネントとサービスが相互に対話できるようにするインターフェイスを提供します。 サービスにバインドされているクライアントがなくなると、Android はサービスを停止します。 

* **`IntentService`** &ndash; _`IntentService`_ は、サービスの作成と使用を簡略化する、`Service` クラスの特殊なサブクラスです。 `IntentService` は、個々の自律呼び出しを処理することを意図しています。 複数の呼び出しを同時に処理できるサービスとは異なり、`IntentService` は作業_キュープロセッサ_&ndash; のようなものであり、処理がキューに登録されており、`IntentService` が1つのワーカースレッドで各ジョブを1つずつ処理します。 通常、`IntentService` はアクティビティまたはフラグメントにバインドされていません。 

* **サービス**の開始 &ndash; 開始した_サービス_は、他の Android コンポーネント (アクティビティなど) によって開始されたサービスであり、サービスが明示的に停止するように指示されるまでバックグラウンドで継続的に実行されます。 バインドされたサービスとは異なり、開始されたサービスにはクライアントが直接バインドされていません。 このため、必要に応じて正常に再起動されるように、サービスを設計することが重要です。

* **ハイブリッドサービス &ndash; ハイブリッド**サービスは、開始された_サービス_とバインドされた_サービス_の特性を持つ_サービスです。_ ハイブリッドサービスは、コンポーネントがそれにバインドされている場合、または何らかのイベントによって開始される場合に、によって開始できます。 クライアントコンポーネントが、ハイブリッドサービスにバインドされていない場合があります。 ハイブリッドサービスは、明示的に停止するように指示されるか、それ以上クライアントがバインドされなくなるまで、実行を継続します。

使用するサービスの種類は、アプリケーションの要件に大きく依存します。 目安として、`IntentService` またはバインドされたサービスは、Android アプリケーションで実行する必要のあるほとんどのタスクに十分なものであるため、この2種類のサービスのいずれかに設定する必要があります。 `IntentService` は、ファイルのダウンロードなどの "ワンショット" タスクに適しています。一方、アクティビティやフラグメントと頻繁にやり取りする必要がある場合は、バインドされたサービスに適しています。 

ほとんどのサービスはバックグラウンドで実行されますが、_フォアグラウンドサービス_と呼ばれる特別なサブカテゴリがあります。 これは、ユーザーに対して何らかの処理 (音楽の再生など) を実行するために、(通常のサービスと比較して) 優先順位の高いサービスです。 

また、同じデバイス上で独自のプロセスでサービスを実行することもできます。これは、_リモートサービス_または_アウトプロセスサービス_と呼ばれることもあります。 これには、作成により多くの労力が必要ですが、アプリケーションが他のアプリケーションと機能を共有する必要があり、場合によっては、アプリケーションのユーザーエクスペリエンスを向上させる必要がある場合に便利です。 

### <a name="background-execution-limits-in-android-80"></a>Android 8.0 のバックグラウンド実行の制限

Android 8.0 (API レベル 26) 以降では、Android アプリケーションはバックグラウンドで自由に実行できるようになりました。 フォアグラウンドの場合、アプリは制限なしでサービスを開始および実行できます。 アプリケーションがバックグラウンドに移行すると、Android はアプリを開始してサービスを使用するために一定の時間を与えます。 この時間が経過すると、アプリはサービスを開始できなくなり、開始されたすべてのサービスが終了します。 この時点では、アプリはどのような処理も実行できません。 Android では、次のいずれかの条件が満たされると、アプリケーションがフォアグラウンドにあると見なされます。

* 表示されているアクティビティ (開始または一時停止) があります。
* アプリはフォアグラウンドサービスを開始しました。
* 別のアプリがフォアグラウンドにあり、他の方法でバックグラウンドで使用されているコンポーネントをアプリから使用しています。 この例としては、フォアグラウンドにあるアプリケーション A がアプリケーション B によって提供されるサービスにバインドされている場合などがあります。アプリケーション B はフォアグラウンドでも考慮され、バックグラウンドでの Android によって終了されることはありません。

アプリがバックグラウンドで実行されている場合でも、Android はアプリを起動して数分でこれらの制限を緩和し、アプリで何らかの作業を実行できるようにします。

* 優先順位の高い焼討ベースクラウドメッセージがアプリによって受信されます。
* アプリはブロードキャストを受信します。 
* アプリケーションは、通知に応答して `PendingIntent` を受信して実行します。

Android 8.0 で発生する可能性のある問題を回避するために、既存の Xamarin Android アプリケーションでバックグラウンド処理を実行する方法を変更する必要がある場合があります。 Android サービスに代わる実用的な方法を次に示します。

* **Android ジョブスケジューラまたは[焼討 Base ジョブディスパッチャー](~/android/platform/firebase-job-dispatcher.md)を使用して、バックグラウンドで実行するように作業をスケジュール**します。これらの2つのライブラリは、アプリケーションがバックグラウンド作業を個々の作業単位である_ジョブ_に分離するためのフレームワークを提供します。 &ndash; します。 その後、アプリは、ジョブを実行できるタイミングに関する条件と共に、オペレーティングシステムを使用してジョブをスケジュールすることができます。
* フォアグラウンドサービスがバックグラウンドで何らかのタスクを実行する必要があり、ユーザーがそのタスクを定期的に操作する必要がある場合に、フォアグラウンドサービスを**フォアグラウンドで開始**&ndash; ます。 フォアグラウンドサービスでは、アプリがバックグラウンドタスクを実行していることをユーザーが認識し、タスクを監視または操作できるように、永続的な通知が表示されます。 この例として、ポッドキャストをユーザーに再生するポッドキャストアプリや、後で楽しんだポッドキャストをダウンロードすることが考えられます。 
* **高優先度の焼討 Base Cloud Message (fcm &ndash;) を使用し**ます。 Android がアプリの優先度の高い fcm を受け取ると、そのアプリは短時間にバックグラウンドでサービスを実行できるようになります。 バックグラウンドでアプリをポーリングするバックグラウンドサービスを使用する代わりに、この方法を使用することをお勧めします。 
* **アプリがフォアグラウンドになったときに作業を延期**する &ndash; 前の解決策がない場合は、アプリがフォアグラウンドになったときに作業を一時停止および再開するための独自の方法をアプリで開発する必要があります。

## <a name="related-links"></a>関連リンク

* [Android Oreo のバックグラウンド実行の制限](https://www.youtube.com/watch?v=Pumf_4yjTMc)
